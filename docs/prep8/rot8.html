
<strong>Objetivos</strong>:
<ul><li>Entender como funciona o contador SysTick</li><li>Entender como configurar o SysTick</li><li>Entender como usar o SysTick com interrupção</li><li>Primeiros passos com interrupção periódica - máquina de estado</li></ul>
<strong>Atividades:</strong>
<ul><li>Teste: <a href="http://goo.gl/forms/kRpKlJcokF" target="_blank">Turma S</a>; <a href="http://goo.gl/forms/LWKmFjGhez" target="_blank">Turma T</a>; <a target="_blank" href="http://goo.gl/forms/B8PFV8muQx">Turma E; Turma M;</a> <a href="http://goo.gl/forms/khAp3jMMtn" target="_blank">Turma U</a>; <a href="http://goo.gl/forms/SAF3GRg41V" target="_blank">Turma W</a></li><li>Leitura e interpretação da seção B3.3 SysTick do manual ARM arquitetura 6
<ul><li>2 registradores que devem ser programados: SYST_RVR e SYST_CSR para gerar uma interrupção a cada 0.01 segundo (10 ms) e manter a variável global de contagem de centésimos de segundos: <tt>cent_global</tt></li><li>O clock da MCU é de 20.48 MHz</li><li>O tratamento de interrupção é feito pela rotina <b>void</b> <b>SysTick_Handler</b>(<b>void</b>) que deve ser declarada como função no programa.</li><li>Fazer em classe um programa parecido com o programa da aula passada, porém agora o incremento do cronômetro deve ser feito no handler do systick e o programa principal deve mostrar o valor do cronômetro tanto no LCD como no terminal. Atenção, o handler do systick não deve ser responsável pela impressão dos valores do cronômetros tanto no LCD como no terminal, pois estas rotinas são demoradas e o handler do systick deve ser o mais rápido possível.</li><li></li></ul>
</li></ul>
<strong>Perguntas para Estudo:</strong>
<ul><li>Sobre o SysTick: @1196</li><li>Sobre o NVIC: @1197</li><li>Sobre tempo de impressão: @1198</li></ul>

<strong>Programa a ser entregue na próxima aula:</strong>
<ul><li>prog8: cronômetro minutos, segundos e <strong>centésimos</strong> de segundo, sendo mostrado no LCD e no programa principal no terminal serial (UART0). Definir um botão ou tecla para parar/continuar a imprimir o cronômetro no terminal. É importante que o valor do cronômetro seja impresso em linhas diferentes, isto é, pulando linhas. Deve-se enviar os caracteres '\n' e '\r' (CR: Carriage Return, Retorno de Carro e LF: line feed, pular de linha)
<ul><li>Note que o programa inicial, planejado para ser feito em classe possui o seguinte problema, dependendo de como foi programado. Quando o programa principal está funcionando e imprimindo os valores tanto no LCD como no terminal, é possível que chegue uma interrupção do Systick em qualquer momento, no meio de uma impressão do cronômetro. Pode acontecer por exemplo, que a rotina está imprimindo o valor do segundo, porém ele está em 00:02:99 e quando o programa foi imprimir o centésimos de segundos, o cronômetro seja incrementado para 00:03:00, neste caso pode ser que o resultado fique 00:02:00 pois o dígito dos segundos já havia sido impresso. Para evitar isso é necessário uma variável de sincronismo entre o systick e o programa principal responsável pela impressão do cronômetro. Adicionalmente há necessidade de criar um novo conjunto de variáveis que são as variáveis do cronômetro que serão acessadas tanto pelo programa principal como pelo Systick:</li><li>variável <tt>rp_global</tt>: (Ready for Print) quando Verdadeira (1) indica que o <tt>cent_global</tt> está correto e pronto para ser impresso; Falsa (0) indica que o <tt>cent_global</tt> já foi impresso no LCD e terminal.</li><li>variável <tt>cent_local</tt>: variável que conta os centésimos, incrementada a cada chamada do Systick. Esta variável deve ser declarada como <tt>static</tt> dentro da função Systick (Pergunta: o que significa o qualificador static na declaração da variável?)</li><li>variável <tt>cent_global</tt>: indica centésimos para ser impresso </li><li>Assim, a rotina de serviço do Systick deve incrementar a variável cent_local e verificar se <tt>rp_global</tt> está falsa, se estiver, copia o <tt>cent_local</tt> para <tt>cent_global</tt>, e faz <tt>rp_global</tt> como verdadeira, indicando que o programa principal pode imprimir o novo valor do cronômetro utilizando o <tt>cent_global</tt>.</li><li>No programa principal, verifica-se se <tt>rp_global</tt> está verdadeiro, se estiver, inicia o processo de imprimir o <tt>cent_global</tt> tanto no LCD como no terminal. Quando terminar a impressão faz <tt>rp_global</tt> ficar falsa. </li></ul>
</li></ul>
<strong>Referências:</strong>
<ul><li>Manual da arquitetura ARM v6: <a href="https://d1b10bmlvqabco.cloudfront.net/attach/i406dyu4aw75jl/hzle6mt0zvk237/i7dpd4xb40ek/arm_v6m_reference_manual.pdf" target="_blank">arm_v6m_reference_manual.pdf</a> (SysTick - Seção B3.3) </li></ul>
